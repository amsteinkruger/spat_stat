---
title: "Lab 3"
author: "Andrew Steinkruger"
format: html
editor: visual
---

```{r preliminaries, warning = FALSE, message = FALSE, echo = FALSE}

# Packages

library(tidyverse)
library(gt)
library(spatstat)

# Data

data <- "data/geog565_lab3_data.csv" %>% read_csv

```

**1.1**

```{r 1_1, echo = FALSE}

# Plots

vis_1_1 = 
  data %>% 
  mutate(group = 
           group %>% 
           factor %>% 
           fct_relevel("commiphora", "termites", "acacia")) %>% 
  ggplot() +
  geom_point(aes(x = x,
                 y = y,
                 color = group)) +
  scale_x_continuous(limits = c(0, 10),
                     breaks = c(0, 10)) +
  scale_y_continuous(limits = c(0, 10),
                     breaks = c(0, 10)) +
  facet_wrap(~ group, ncol = 3) +
  coord_fixed() +
  theme_minimal() +
  theme(legend.position = "none")

vis_1_1

```

-   The Commiphora shrubs are clustered over space: most points are close to a small subset of other points and far from all other points.

-   The termite mounds are dispersed over space: most points share near-identical nearest-neighbor distances.

-   The Acacia senegal trees are randomly distributed over space: distances between points vary substantially with no clear pattern.

**1.2**

```{r 1_2, warning = FALSE, message = FALSE, echo = FALSE}

dat_quads = 
  tibble(x = 
           seq(1, 10) %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         y = 
           seq(1, 10) %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),) %>% 
  expand(x, y) %>% 
  mutate(quad = paste0("(", x, ", ", y, ")")) %>% 
  select(quad)

par_N = dat_quads %>% nrow
par_lambda = 150 / 100

dat_1_2 = 
  data %>% 
  mutate(quad_x = 
           x %>% 
           ceiling %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         quad_y = 
           y %>% 
           ceiling %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         quad = paste0("(", quad_x, ", ", quad_y, ")")) %>% 
  group_by(group, quad) %>% 
  summarize(count = n()) %>% 
  ungroup %>% 
  arrange(group, quad)

dat_1_2_wrangle = 
  dat_1_2 %>% 
  group_by(group) %>% 
  expand(dat_quads) %>% 
  ungroup %>% 
  left_join(dat_1_2) %>% 
  mutate(count = count %>% replace_na(0)) %>% 
  group_by(group, count) %>% 
  summarize(O = n()) %>% 
  ungroup %>% 
  mutate(P = exp(-par_lambda) * par_lambda ^ count * (1 / factorial(count)),
         E = P * par_N,
         aggregate = 
           c(seq(1, 4), rep(5, 4), # Acacia
             c(1, 2, 3, 3, 4, 4, 5, 6, 6, 6, 6), # Commiphora
             c(1, 1, 2, 3))) %>% # Termites
  group_by(group, aggregate) %>% 
  mutate(O_agg = sum(O),
         E_agg = sum(E)) %>% 
  ungroup %>% 
  mutate(Chi_partial = (O_agg - E_agg) ^ 2 * (1 / E_agg))
  
dat_1_2_chi = 
  dat_1_2_wrangle %>% 
  distinct(group, Chi_partial) %>% # Fragile
  group_by(group) %>% 
  summarize(Chi_sq = sum(Chi_partial),
            degrees = n() - 2) %>% 
  ungroup %>% 
  mutate(value = c(7.815, 9.488, 3.841), # Fragile
         reject = Chi_sq > value,
         group =
           group %>%
           factor %>%
           fct_relevel("commiphora", "termites", "acacia")) %>%
  arrange(group)

tab_1_2_1 = 
  dat_1_2_wrangle %>% 
  filter(group == "commiphora") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | *Commiphora* Shrubs")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_2 = 
  dat_1_2_wrangle %>% 
  filter(group == "termites") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | Termite Mounds")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_3 = 
  dat_1_2_wrangle %>% 
  filter(group == "acacia") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | *Acacia senegal* Trees")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_chi =
  dat_1_2_chi %>% 
  mutate(across(c(Chi_sq, value), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = html("&#967;<sup>2</sup> Results")) %>% 
  cols_label(group = "Group",
             Chi_sq = html("&#967;<sup>2</sup>"),
             degrees = "DF",
             value = html("Critical Value"),
             reject = "Reject")
  
```

The following tables report statistics by group (e.g. Commiphora) for each quadrat count.

Column "j" indexes aggregations of x such that each j has a sum of x equal to or greater than 5.

Columns "O~j~", "E~j~", and "Partial Chi-Squared" then report results for each j (with repetition).

```{r 1_2_print_1, echo = FALSE}

tab_1_2_1

tab_1_2_2

tab_1_2_3


```

The following table reports chi-squared values and tests of significance for each group.

```{r 1_2_print_2, echo = FALSE}

tab_1_2_chi

```

**1.3**

For each group, I am testing the null hypothesis of complete randomness by comparing the observed ch-squared to a critical value of the chi-squared distribution with reference to the available degrees of freedom and selected p-value. If the observed value is greater than the critical value, then I can reject the null hypothesis that the observed points are distributed by a homogeneous planar Poisson point process and thus that the points are distributed under complete randomness.

Column "Reject" in the preceding table reports the results of these comparisons as logical values.

**1.4**

Please refer to the preceding table for chi-squared values.

-   For Commiphora shrubs, I reject the null hypothesis.

-   For termite mounds, I reject the null hypothesis.

-   For Acacia senegal trees, I cannot reject the null hypothesis.

Note that these results conform to the visual results in (1.1).

**1.5**

With reference to provided values for variance and lambda:

-   Commiphora shrubs are clustered.

-   Termite mounds are dispersed.

-   Acacia senegal trees appear to be clustered, but our hypothesis testing suggests this is spurious.

**1.6**

Quadrat analysis requires points that are given, not selected by the researcher, as well as sufficient observations for the chi-squared test. Quadrat analysis also requires the researcher to choose the grain, extent, and position of quadrats. That is, quadrat analysis cannot detect patterns at multiple scales and could suffer from edge effects at the boundaries of each quadrat.

**EC.**

**2.1**

```{r 2_1, warning = FALSE, message = FALSE}

# Get histograms of nearest-neighbor distances.

dat_nn_com =
  ppp(data %>% filter(group == "commiphora") %>% pull(x), 
      data %>% filter(group == "commiphora") %>% pull(y), 
      window = owin(c(0, 10), c(0, 10))) %>% 
  nndist %>% 
  tibble(NN = .,
         Group = "commiphora")

dat_nn_ter = 
  ppp(data %>% filter(group == "termites") %>% pull(x), 
      data %>% filter(group == "termites") %>% pull(y), 
      window = owin(c(0, 10), c(0, 10))) %>% 
  nndist %>% 
  tibble(NN = .,
         Group = "termites")

dat_nn_aca = 
  ppp(data %>% filter(group == "acacia") %>% pull(x), 
      data %>% filter(group == "acacia") %>% pull(y), 
      window = owin(c(0, 10), c(0, 10))) %>% 
  nndist %>% 
  tibble(NN = .,
         Group = "acacia")

dat_nn = 
  dat_nn_com %>% 
  bind_rows(dat_nn_ter) %>% 
  bind_rows(dat_nn_aca)

vis_nn = 
  dat_nn %>% 
  mutate(Group = 
           Group %>% 
           factor %>% 
           fct_relevel("commiphora", "termites", "acacia")) %>% 
  ggplot() +
  geom_histogram(aes(x = NN,
                     fill = Group)) +
  labs(x = "Nearest-Neighbor Distance",
       y = "Count") +
  facet_wrap(~ Group, ncol = 3) +
  theme_minimal() +
  theme(legend.position = "none")

vis_nn
  
```

-   The *Commiphora* shrubs have shorter nearest-neighbor distances centered around 0.25, suggesting clustering.

-   The termite mounds have moderate nearest-neighbor distances in a distribution centered around 0.75 with little variance, suggesting dispersal.

-   The *Acacia senegal* trees have a wide range of nearest-neighbor distances in a distribution centered around 0.50 with greater variance than the other two distributions, suggesting randomness.

**2.2 - 2.6**

In the following table, variables prefixed "Obs\_" are observed values (**2.2**) while "Exp_Mean" is the expected mean (**2.3**). For each group, I am testing the null hypothesis of complete randomness in nearest-neighbor distances (**2.4**). "Z" reports Z-statistics (**2.5**). "Reject" reports the results of hypothesis tests for *p* \< 0.05; for *Commiphora* shrubs and termite mounds, I reject the null hypothesis because each group's Z-statistic outside the range of critical values (-1.96, 1.96), while for *Acacia senegal* trees, I cannot reject the null hypothesis because the group's Z-statistic falls inside the range of critical values (**2.6**).

```{r 2_2}

tab_nn = 
  dat_nn %>% 
  mutate(Group = 
           Group %>% 
           factor %>% 
           fct_relevel("commiphora", "termites", "acacia")) %>% 
  group_by(Group) %>% 
  summarize(Obs_Mean = mean(NN),
            Obs_Var = var(NN),
            Obs_SE = sd(NN) / sqrt(n()),
            Exp_Mean = 0.5 * sqrt(100 / n()),
            Z = (Obs_Mean - Exp_Mean) / Obs_SE) %>% 
  mutate(Reject = abs(Z) > 1.96) %>% 
  mutate(across(2:6, ~ round(.x, 2))) %>% 
  gt

tab_nn

```

**2.7**

-   *Commiphora* shrubs are clustered because their observed mean nearest-neighbor distance is less than the expected mean nearest-neighbor distance and the Z-statistic testing this relationship indicates significance at *p* \< 0.05.

-   Termite mounds are dispersed because their observed mean nearest-neighbor distance is greater than the expected mean nearest-neighbor distance and the Z-statistic testing this relationship indicates significance at *p* \< 0.05.

-   *Acacia senegal* trees appear to be clustered by comparison of the observed and expected means, but our hypothesis testing suggests this is spurious.

**2.8**

Nearest-neighbor analysis requires points that are given, not selected by the researcher, and is subject to bias from edge effects.

**3.1**

```{r 3_1, eval = FALSE}

par(mfrow = c(1, 3), bty = 'n')

# Commiphora

dat_nn_com %>% 
  pull(NN) %>% 
  sort %>%
  plot(., 
       1:length(.),
       xlab = 'r (distance m)',
       ylab = 'F(r)', main = 'commiphora',
       pch = 21, bg = "blue")

# Termites

dat_nn_ter %>% 
  pull(NN) %>% 
  sort %>%
  plot(., 
       1:length(.),
       xlab = 'r (distance m)',
       ylab = 'F(r)', main = 'termites',
       pch = 21, bg = "blue")

# Acacia

dat_nn_aca %>% 
  pull(NN) %>% 
  sort %>%
  plot(., 
       1:length(.),
       xlab = 'r (distance m)',
       ylab = 'F(r)', main = 'acacia',
       pch = 21, bg = "blue")

par(mfrow = c(1, 1))

```

*r* is a variable radius. *F(r)* is the complete distribution function of all observed nearest-neighbor distances for each *r*.

**3.2**

-   *Commiphora* shrubs appear to be clustered because the corresponding *F(r)* increases steeply for lower values of *r*, indicating that most distances are shorter rather than longer.

-   Termite mounds appear to be dispersed because the corresponding *F(r)* increases steeply for higher values of *r*, indicating that most distances are longer rather than shorter. We can also note relatively little variance in *F(r)* over values of *r*, which corresponds to similar observations in quadrat and NN analysis.

-   *Acacia senegal* trees are not clearly clustered or dispersed because the corresponding *F(r)* is not clearly different than the cumulative distribution function of a normal distribution.

**3.3**

The clustering of *Commiphora* shrubs appears to occur on a scale of around 0.25 m, while the dispersal of termite mounds appears to occur on a scale of around 0.75 m. There is no clear pattern on any relevant scale for *Acacia senegal* trees.

**4.1**

How does the Ripley’s K second order analysis differ from the refined nearest neighbor analysis?

**4.2**

```{r 4_2, eval = FALSE}

############# COMMIPHORA 4. ################

# subset just the commiphora data
data_subset_com <- subset(data, group == "commiphora")

# get the NN-distances histogram
data.ppp <- ppp(data_subset_com$x, data_subset_com$y, window = owin(c(0,10), c(0,10)))

# run the Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'commiphora')

############# TERMITES 4. ################

# subset just termites 
data_subset_term <- subset(data, group == "termites")

# get the NN-distances histogram
data.ppp <- ppp(data_subset_term$x, data_subset_term$y, window = owin(c(0,10), c(0,10)))

# run the Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'termites')


############# ACACIA 4. ################

# subset just acacia 
data_subset_ac <- subset(data, group == "acacia")

# get NN-distances histogram
data.ppp <- ppp(data_subset_ac$x, data_subset_ac$y, window = owin(c(0,10), c(0,10)))

# run Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'Acacia')

```

Plot the Ripley’s K function, L(r), as a function of d (lag distance) for each dataset. Insert these plots into your lab submission. Describe, in your own words, what L(r) and r represent.

**4.3**

Interpret the point patterns based on the curves in the Ripley’s K plots by comparing the results to the envelope for the null hypothesis (Complete Spatial Randomness, CSR). Explain how the CSR envelope is constructed, and how it helps you interpret the significance of pattern based on the Ripley’s K plot.

**4.4**

What can you say about the scale of patterns for the three species? Are there multiple scales of patterns?

**4.5**

What benefits do Refined Nearest Neighbor and Ripley’s K analyses offer over conducting a quadrat and nearest neighbor analysis?

**5.1.a**

(See .pdf.)

Bruce and Tom have data showing the locations of West Nile virus infected populations of birds, tire dumps, and natural wetlands. West Nile virus is transmitted through mosquito bites, and mosquitos breed in quiet water. Their questions are: What is the spatial pattern of West Nile infections? and;

**5.1.b.**

Are tire dumps and/or natural wetlands associated with West Nile infections?

**5.2.a**

Laurie has conducted surveys of exotic plant occurrences along roads. For each 0.2 km section of road, she has noted the presence/absence of each of eight common exotic plant species. For each road segment, she also knows the elevation, aspect, age of the road, and usage level of the road. Her questions are: What are the spatial patterns of exotic plants along roads?, and;

**5.2.b**

What factors are associated with the spatial pattern of exotic plants along roads?

**5.3.a**

Shira has created a dataset showing the locations of conflicts over water resources, as well as the basin boundaries, nearby cities and their populations, and socioeconomic data. Her questions are: What is the spatial pattern of water resource conflicts? and;

**5.2.b**

What factors are associated with water resource conflicts?\
