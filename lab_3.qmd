---
title: "Lab 3"
author: "Andrew Steinkruger"
format: html
editor: visual
---

```{r preliminaries, warning = FALSE, message = FALSE, echo = FALSE}

# Packages

library(tidyverse)
library(gt)
library(spatstat)

# Data

data <- "data/geog565_lab3_data.csv" %>% read_csv

```

**1.1**

```{r 1_1, echo = FALSE}

# Plots

vis_1_1 = 
  data %>% 
  mutate(group = 
           group %>% 
           factor %>% 
           fct_relevel("commiphora", "termites", "acacia")) %>% 
  ggplot() +
  geom_point(aes(x = x,
                 y = y,
                 color = group)) +
  scale_x_continuous(limits = c(0, 10),
                     breaks = c(0, 10)) +
  scale_y_continuous(limits = c(0, 10),
                     breaks = c(0, 10)) +
  facet_wrap(~ group, ncol = 3) +
  coord_fixed() +
  theme_minimal() +
  theme(legend.position = "none")

vis_1_1

```

-   The *Commiphora* shrubs are clustered over space: most points are close to a small subset of other points and far from all other points.

-   The termite mounds are dispersed over space: most points share near-identical nearest-neighbor distances.

-   The *Acacia senegal* trees are randomly distributed over space: distances between points vary substantially with no clear pattern.

**1.2**

```{r 1_2, warning = FALSE, message = FALSE, echo = FALSE}

dat_quads = 
  tibble(x = 
           seq(1, 10) %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         y = 
           seq(1, 10) %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),) %>% 
  expand(x, y) %>% 
  mutate(quad = paste0("(", x, ", ", y, ")")) %>% 
  select(quad)

par_N = dat_quads %>% nrow
par_lambda = 150 / 100

dat_1_2 = 
  data %>% 
  mutate(quad_x = 
           x %>% 
           ceiling %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         quad_y = 
           y %>% 
           ceiling %>% 
           ifelse(nchar(.) == 1, 
                  paste0("0", .),
                  .),
         quad = paste0("(", quad_x, ", ", quad_y, ")")) %>% 
  group_by(group, quad) %>% 
  summarize(count = n()) %>% 
  ungroup %>% 
  arrange(group, quad)

dat_1_2_wrangle = 
  dat_1_2 %>% 
  group_by(group) %>% 
  expand(dat_quads) %>% 
  ungroup %>% 
  left_join(dat_1_2) %>% 
  mutate(count = count %>% replace_na(0)) %>% 
  group_by(group, count) %>% 
  summarize(O = n()) %>% 
  ungroup %>% 
  mutate(P = exp(-par_lambda) * par_lambda ^ count * (1 / factorial(count)),
         E = P * par_N,
         aggregate = 
           c(seq(1, 4), rep(5, 4), # Acacia
             c(1, 2, 3, 3, 4, 4, 5, 6, 6, 6, 6), # Commiphora
             c(1, 1, 2, 3))) %>% # Termites
  group_by(group, aggregate) %>% 
  mutate(O_agg = sum(O),
         E_agg = sum(E)) %>% 
  ungroup %>% 
  mutate(Chi_partial = (O_agg - E_agg) ^ 2 * (1 / E_agg))
  
dat_1_2_chi = 
  dat_1_2_wrangle %>% 
  distinct(group, Chi_partial) %>% # Fragile
  group_by(group) %>% 
  summarize(Chi_sq = sum(Chi_partial),
            degrees = n() - 2) %>% 
  ungroup %>% 
  mutate(value = c(7.815, 9.488, 3.841), # Fragile
         reject = Chi_sq > value,
         group =
           group %>%
           factor %>%
           fct_relevel("commiphora", "termites", "acacia")) %>%
  arrange(group)

tab_1_2_1 = 
  dat_1_2_wrangle %>% 
  filter(group == "commiphora") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | *Commiphora* Shrubs")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_2 = 
  dat_1_2_wrangle %>% 
  filter(group == "termites") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | Termite Mounds")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_3 = 
  dat_1_2_wrangle %>% 
  filter(group == "acacia") %>% 
  select(-group) %>% 
  mutate(across(everything(), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = md("Intermediate Results | *Acacia senegal* Trees")) %>% 
  cols_label(count = html("<em>x</em>"),
             O = html("<em>O<sub>i</sub></em>"),
             P = html("<em>p(x)</em>"),
             E = html("<em>E<sub>i</sub></em>"),
             aggregate = html("<em>j</em>"),
             O_agg = html("<em>O<sub>j</sub></em>"),
             E_agg = html("<em>E<sub>j</sub></em>"),
             Chi_partial = html("Partial &#967;<sup>2</sup>"))

tab_1_2_chi =
  dat_1_2_chi %>% 
  mutate(across(c(Chi_sq, value), ~ round(.x, 2))) %>% 
  gt %>% 
  tab_header(title = html("&#967;<sup>2</sup> Results")) %>% 
  cols_label(group = "Group",
             Chi_sq = html("&#967;<sup>2</sup>"),
             degrees = "DF",
             value = html("Critical Value"),
             reject = "Reject")
  
```

The following tables report statistics by group (e.g. *Commophora*) for each quadrat count.

Column "*j*" indexes aggregations of *x* such that each *j* has a sum of *x* equal to or greater than 5.

Columns "*O~j~*", "*E~j~*", and "Partial Chi-Squared" then report duplicate results for each *j.*

```{r 1_2_print_1, echo = FALSE}

tab_1_2_1

tab_1_2_2

tab_1_2_3


```

The following table reports chi-squared values and tests of significance for each group.

```{r 1_2_print_2, echo = FALSE}

tab_1_2_chi

```

**1.3**

For each group, I am testing the null hypothesis of complete randomness by comparing the observed ch-squared to a critical value of the chi-squared distribution with reference to the available degrees of freedom and selected *p*-value. If the observed value is greater than the critical value, then I can reject the null hypothesis that the observed points are distributed by a homogeneous planar Poisson point process and thus that the points are distributed under complete randomness.

Column "Reject" in the preceding table reports the results of these comparisons as logical values.

**1.4**

Please refer to the preceding table for chi-squared values.

-   For *Commiphora* shrubs, I reject the null hypothesis.

-   For termite mounds, I reject the null hypothesis.

-   For *Acacia senegal* trees, I cannot reject the null hypothesis.

Note that these results conform to the visual results in (1.1).

**1.5**

With referenced to provided values for variance and lambda:

-   *Commiphora* shrubs are clustered.

-   Termite mounds are dispersed.

-   *Acacia senegal* trees appear to be clustered, but our hypothesis testing suggests this is spurious.

**1.6**

State the limitations to quadrat analysis.

**EC.**

Conduct a second quadrat analysis using a 5x5 grid. (See .pdf.)

**2.1**

```{r 2_1, eval = FALSE}

# Note reordering from provided code.

# (!!!) Unfuck object overwriting.

# Subset just the commiphora
data_subset_com <- subset(data, group == "commiphora")

# Get the NN-distances histogram
data.ppp <- ppp(data_subset_com$x, data_subset_com$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)
hist(data.nnd, main = "commiphora")

# Subset just the termites
data_subset_term <- subset(data, group == "termites")

# Get the NN-distances histogram
data.ppp <- ppp(data_subset_term$x, data_subset_term$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)
hist(data.nnd, main = "termites")

# Subset just the acacia
data_subset_ac <- subset(data, group == "acacia")

# Get the NN-distances histogram
data.ppp <- ppp(data_subset_ac$x, data_subset_ac$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)
hist(data.nnd, main = "acacia")

```

Paste your histograms. (See .pdf.)

**2.2**

```{r 2_2, eval = FALSE}

# As above, work out overwritten objects.

mean.nnd <- mean(data.nnd)

var.nnd <- var(data.nnd)

```

Calculate the observed mean and variance of NND . . .. (See .pdf.)

**2.3**

```{r 2_3, eval = FALSE}

exp.nnd  <- 0.5 * sqrt(100 / nrow(data_subset_com))

```

Calculate the expected mean NND. (See .pdf.)

**2.4**

What is the null hypothesis?

**2.5**

```{r 2_5, eval = FALSE}

z.commiphora <- (mean.nnd - exp.nnd) / se.mean

```

Determine the Z-statistic . . .. (See .pdf.)

**2.6**

For each dataset, do you accept/reject the hypothesis? On what basis?

**2.7**

State how you interpret the pattern . . .. (See .pdf.)

**2.8**

State the limitations of using a nearest-neighbor analysis.

**3.1**

```{r 3_1, eval = FALSE}

############# COMMIPHORA 3. ################

# load the NN-distances
data_subset_com <- subset(data, group == "commiphora")
data.ppp <- ppp(data_subset_com$x, data_subset_com$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)

# plot F(r) as function of R
plot(sort(data.nnd), 1:length(data.nnd),
     xlab = 'r (distance m)',
     ylab = 'F(r)', main = 'commiphora',
     pch =21, bg="blue")

############# Termites 3. ################

# load the NN-distances
data_subset_term <- subset(data, group == "termites")
data.ppp <- ppp(data_subset_term$x, data_subset_term$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)

# plot F(r) as function of R
plot(sort(data.nnd), 1:length(data.nnd),
     xlab = 'r (distance m)',
     ylab = 'F(r)', main = 'termites',
     pch = 21, bg="blue")

############# ACACIA 3. ################

# load the NN-distances
data_subset_ac <- subset(data, group == "acacia")
data.ppp <- ppp(data_subset_ac$x, data_subset_ac$y, window = owin(c(0,10), c(0,10)))
data.nnd <- nndist(data.ppp)

# plot F(r) as function of R
plot(sort(data.nnd), 1:length(data.nnd),
     xlab = 'r (distance m)',
     ylab = 'F(r)', main = 'acacia',
     pch = 21, bg="blue")

```

Plot F(r) as a function of r for each of the three data sets. Describe, in your own words, what F(r) and r represent.

**3.2**

Are the locations of the three species clustered, dispersed or random? Interpret the spatial patterns of the points based on the shapes of the curves.

**3.3**

What can you say about the scale of patterns observed?

**4.1**

How does the Ripley’s K second order analysis differ from the refined nearest neighbor analysis?

**4.2**

```{r 4_2, eval = FALSE}

############# COMMIPHORA 4. ################

# subset just the commiphora data
data_subset_com <- subset(data, group == "commiphora")

# get the NN-distances histogram
data.ppp <- ppp(data_subset_com$x, data_subset_com$y, window = owin(c(0,10), c(0,10)))

# run the Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'commiphora')

############# TERMITES 4. ################

# subset just termites 
data_subset_term <- subset(data, group == "termites")

# get the NN-distances histogram
data.ppp <- ppp(data_subset_term$x, data_subset_term$y, window = owin(c(0,10), c(0,10)))

# run the Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'termites')


############# ACACIA 4. ################

# subset just acacia 
data_subset_ac <- subset(data, group == "acacia")

# get NN-distances histogram
data.ppp <- ppp(data_subset_ac$x, data_subset_ac$y, window = owin(c(0,10), c(0,10)))

# run Ripley's K second order analysis
plot(envelope(data.ppp, fun=Kest, confidence = 0.95,
              correction = "Ripley", var.approx = TRUE),
     main = 'Acacia')

```

Plot the Ripley’s K function, L(r), as a function of d (lag distance) for each dataset. Insert these plots into your lab submission. Describe, in your own words, what L(r) and r represent.

**4.3**

Interpret the point patterns based on the curves in the Ripley’s K plots by comparing the results to the envelope for the null hypothesis (Complete Spatial Randomness, CSR). Explain how the CSR envelope is constructed, and how it helps you interpret the significance of pattern based on the Ripley’s K plot.

**4.4**

What can you say about the scale of patterns for the three species? Are there multiple scales of patterns?

**4.5**

What benefits do Refined Nearest Neighbor and Ripley’s K analyses offer over conducting a quadrat and nearest neighbor analysis?

**5.1.a**

(See .pdf.)

Bruce and Tom have data showing the locations of West Nile virus infected populations of birds, tire dumps, and natural wetlands. West Nile virus is transmitted through mosquito bites, and mosquitos breed in quiet water. Their questions are: What is the spatial pattern of West Nile infections? and;

**5.1.b.**

Are tire dumps and/or natural wetlands associated with West Nile infections?

**5.2.a**

Laurie has conducted surveys of exotic plant occurrences along roads. For each 0.2 km section of road, she has noted the presence/absence of each of eight common exotic plant species. For each road segment, she also knows the elevation, aspect, age of the road, and usage level of the road. Her questions are: What are the spatial patterns of exotic plants along roads?, and;

**5.2.b**

What factors are associated with the spatial pattern of exotic plants along roads?

**5.3.a**

Shira has created a dataset showing the locations of conflicts over water resources, as well as the basin boundaries, nearby cities and their populations, and socioeconomic data. Her questions are: What is the spatial pattern of water resource conflicts? and;

**5.2.b**

What factors are associated with water resource conflicts?\
